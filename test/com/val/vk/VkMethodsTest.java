package com.val.vk;

import com.google.gson.Gson;
import com.val.vk.exceptions.EmptyParamException;
import com.val.vk.exceptions.SendMessageErrorException;
import org.junit.After;
import org.junit.BeforeClass;
import org.junit.Test;

import java.io.IOException;

import static org.junit.Assert.assertEquals;
import static org.junit.Assert.assertTrue;
import static org.mockito.Mockito.mock;
import static org.mockito.Mockito.when;

public class VkMethodsTest {
    private static VkMethods vk;
    private static String securityToken = "9bdcf2fa1612d472284d519d6473f7b8e98498362438b03ecf542f74461fe25c7e15c89ba8d311b5e94b8";
    private static String userId = "204437607";
    private static HttpsGetter httpsGetter = new HttpsGetter();
    private static int[] ids;


    @BeforeClass
    public static void before(){
        vk = new VkMethods(httpsGetter, securityToken, userId);
        ids = new int[]{Integer.parseInt(userId)};

    }

    @After
    public void after(){
        vk = new VkMethods(new HttpsGetter(), securityToken, userId);
    }

    @Test(expected = EmptyParamException.class)
    public void getUsers_emptyUsersIdArgument_EmptyParamException() throws EmptyParamException {
        vk.getUsers(new int[]{});
    }

    @Test(expected = NullPointerException.class)
    public void getUsers_NullIdArgument_NullPointerException() throws EmptyParamException {
        vk.getUsers(null);
    }

    @Test
    public void getUsers_ids_UserList() throws EmptyParamException, IOException {

        String url = "https://api.vk.com/method/users.get?v=5.52&user_ids=204437607";
        String expectedJson = "{\"response\":[{\"id\":204437607,\"first_name\":\"Dog\",\"last_name\":\"Cat\",\"hidden\":1}]}";

        httpsGetter = mock(HttpsGetter.class);
        when(httpsGetter.get(url)).thenReturn(expectedJson);

        UserList actual = new VkMethods(httpsGetter, securityToken, userId).getUsers(ids);
        String actualJson = new Gson().toJson(actual);

        assertEquals(expectedJson, actualJson);
    }

    @Test
    public void getDialogs_countZeroOrLess_returnsOneDialog() throws IOException {
        String targetUrl = "https://api.vk.com/method/messages.getDialogs?access_token=9bdcf2fa1612d472284d519d6473f7b8e98498362438b03ecf542f74461fe25c7e15c89ba8d311b5e94b8&v=5.52&count=1";
        String expectedJson = "{\"response\":{\"count\":32,\"unread_dialogs\":1,\"items\":[{\"unread\":3,\"message\":{\"id\":53010,\"date\":1521375264,\"out\":0,\"user_id\":17193224,\"read_state\":0,\"title\":\"\",\"body\":\"Зарегистрируйтесь на Airbnb и получите скидку $35 на первое приключение. Вот моя ссылка с приглашением: https:\\/\\/abnb.me\\/e\\/ftK7OJmZnL\"},\"in_read\":53002,\"out_read\":53010}]}}";
        httpsGetter = mock(HttpsGetter.class);
        vk = new VkMethods(httpsGetter, securityToken, userId);
        when(httpsGetter.get(targetUrl)).thenReturn(expectedJson);

        String actualJson = new Gson().toJson(vk.getDialogs(-1));

        expectedJson = "[{\"unread\":3,\"message\":{\"id\":53010,\"user_id\":17193224,\"from_id\":0,\"date\":1521375264,\"read_state\":0,\"out\":0,\"title\":\"\",\"body\":\"Зарегистрируйтесь на Airbnb и получите скидку $35 на первое приключение. Вот моя ссылка с приглашением: https://abnb.me/e/ftK7OJmZnL\",\"emoji\":0,\"deleted\":0}}]";
        assertEquals(expectedJson, actualJson);
    }

    @Test
    public void getDialogs_countBiggerThen200_returnsAllDialogs() throws IOException {
        String targetUrl = "https://api.vk.com/method/messages.getDialogs?access_token=9bdcf2fa1612d472284d519d6473f7b8e98498362438b03ecf542f74461fe25c7e15c89ba8d311b5e94b8&v=5.52&count=200";
        String expectedJson = "{\"response\":{\"count\":32,\"unread_dialogs\":1,\"items\":[{\"unread\":3,\"message\":{\"id\":53010,\"date\":1521375264,\"out\":0,\"user_id\":17193224,\"read_state\":0,\"title\":\"\",\"body\":\"Зарегистрируйтесь на Airbnb и получите скидку $35 на первое приключение. Вот моя ссылка с приглашением: https:\\/\\/abnb.me\\/e\\/ftK7OJmZnL\"},\"in_read\":53002,\"out_read\":53010},{\"message\":{\"id\":53007,\"date\":1520982614,\"out\":0,\"user_id\":204437607,\"read_state\":1,\"title\":\"\",\"body\":\"he\",\"random_id\":0},\"in_read\":53007,\"out_read\":53007},{\"message\":{\"id\":52997,\"date\":1520675935,\"out\":1,\"user_id\":1253301,\"read_state\":1,\"title\":\"\",\"body\":\"чтоб я чартер заказывал)\",\"random_id\":1245455915},\"in_read\":52997,\"out_read\":52997},{\"message\":{\"id\":52925,\"date\":1519285055,\"out\":0,\"user_id\":396899152,\"read_state\":1,\"title\":\"\",\"body\":\"Здравствуйте. В субботу в 15.00 запланировано занятие. У Вас получится его посетить?\"},\"in_read\":52925,\"out_read\":52925},{\"message\":{\"id\":52894,\"date\":1512926340,\"out\":1,\"user_id\":84355724,\"read_state\":1,\"title\":\"\",\"body\":\"ок определюсь на днях\",\"random_id\":1057483921},\"in_read\":52894,\"out_read\":52894},{\"message\":{\"id\":52844,\"date\":1511623453,\"out\":0,\"user_id\":90928490,\"read_state\":1,\"title\":\"\",\"body\":\"чуть позже гляну)\"},\"in_read\":52844,\"out_read\":52844},{\"message\":{\"id\":52833,\"date\":1511198591,\"out\":0,\"user_id\":137268284,\"read_state\":1,\"title\":\"\",\"body\":\"Да ))\"},\"in_read\":52833,\"out_read\":52833},{\"message\":{\"id\":52762,\"date\":1510830380,\"out\":0,\"user_id\":286244973,\"read_state\":1,\"title\":\"\",\"body\":\"А сегодня будет вратарьская\"},\"in_read\":52762,\"out_read\":52762},{\"message\":{\"id\":52754,\"date\":1510299800,\"out\":0,\"user_id\":16377310,\"read_state\":1,\"title\":\"\",\"body\":\"Хорошо\"},\"in_read\":52754,\"out_read\":52754},{\"message\":{\"id\":52739,\"date\":1509777876,\"out\":1,\"user_id\":69377648,\"read_state\":1,\"title\":\"\",\"body\":\"как то так знаю это странно\\nно бля я же басист в конце концов\",\"random_id\":0},\"in_read\":52739,\"out_read\":52739},{\"message\":{\"id\":52680,\"date\":1506373105,\"out\":1,\"user_id\":181244406,\"read_state\":1,\"title\":\"\",\"body\":\"спс бро\",\"random_id\":0},\"in_read\":52680,\"out_read\":52680},{\"message\":{\"id\":52511,\"date\":1505727892,\"out\":1,\"user_id\":63442680,\"read_state\":1,\"title\":\"\",\"body\":\"Дэбил чтоли со своей учетки клюшки впаривать ))))\",\"random_id\":0},\"in_read\":52511,\"out_read\":52511},{\"message\":{\"id\":52509,\"date\":1502371985,\"out\":1,\"user_id\":6918214,\"read_state\":1,\"title\":\"\",\"body\":\"https:\\/\\/drive.google.com\\/open?id=0B_I0NH8zJXt0Tl83U2NOOV90aUk\",\"random_id\":0},\"in_read\":52509,\"out_read\":52509},{\"message\":{\"id\":52241,\"date\":1483213246,\"out\":0,\"user_id\":134160651,\"read_state\":1,\"title\":\"\",\"body\":\"Точно, и нового тебе шлема) с коброй золотой, как ты хотел)\"},\"in_read\":52241,\"out_read\":52241},{\"message\":{\"id\":52222,\"date\":1482940870,\"out\":1,\"user_id\":225976680,\"read_state\":1,\"title\":\"\",\"body\":\"\",\"random_id\":0,\"attachments\":[{\"type\":\"photo\",\"photo\":{\"id\":456239020,\"album_id\":-3,\"owner_id\":204437607,\"photo_75\":\"https:\\/\\/pp.userapi.com\\/c626727\\/v626727607\\/440a2\\/K30pGMgGZGI.jpg\",\"photo_130\":\"https:\\/\\/pp.userapi.com\\/c626727\\/v626727607\\/440a3\\/m5Qxf6RbMBQ.jpg\",\"photo_604\":\"https:\\/\\/pp.userapi.com\\/c626727\\/v626727607\\/440a4\\/BOKEDzsNMm4.jpg\",\"photo_807\":\"https:\\/\\/pp.userapi.com\\/c626727\\/v626727607\\/440a5\\/0NJaefoy_Mc.jpg\",\"width\":608,\"height\":807,\"text\":\"\",\"date\":1482940856,\"access_key\":\"fdd0ed577109216237\"}},{\"type\":\"photo\",\"photo\":{\"id\":456239021,\"album_id\":-3,\"owner_id\":204437607,\"photo_75\":\"https:\\/\\/pp.userapi.com\\/c626727\\/v626727607\\/440aa\\/kzy4qJ9hwBY.jpg\",\"photo_130\":\"https:\\/\\/pp.userapi.com\\/c626727\\/v626727607\\/440ab\\/2NeYzjrTtRo.jpg\",\"photo_604\":\"https:\\/\\/pp.userapi.com\\/c626727\\/v626727607\\/440ac\\/XKxBP_hQXVo.jpg\",\"photo_807\":\"https:\\/\\/pp.userapi.com\\/c626727\\/v626727607\\/440ad\\/PDl1ok4hdp4.jpg\",\"photo_1280\":\"https:\\/\\/pp.userapi.com\\/c626727\\/v626727607\\/440ae\\/Er3MPM8vI74.jpg\",\"photo_2560\":\"https:\\/\\/pp.userapi.com\\/c626727\\/v626727607\\/440af\\/1ryjcad97Kk.jpg\",\"width\":723,\"height\":1280,\"text\":\"\",\"date\":1482940869,\"access_key\":\"be85510d8c33966562\"}}]},\"in_read\":52222,\"out_read\":52222},{\"message\":{\"id\":52066,\"date\":1476454476,\"out\":0,\"user_id\":3783801,\"read_state\":1,\"title\":\"\",\"body\":\"Привет , забыл ?)\"},\"in_read\":52066,\"out_read\":52066},{\"message\":{\"id\":51473,\"date\":1475221010,\"out\":1,\"user_id\":374417194,\"read_state\":0,\"title\":\"\",\"body\":\"Привет Вентиль с днюхой тебя !\",\"random_id\":0},\"in_read\":51473,\"out_read\":0},{\"message\":{\"id\":48081,\"date\":1468348590,\"out\":0,\"user_id\":110938977,\"read_state\":1,\"title\":\"\",\"body\":\"\uD83D\uDE0A\",\"emoji\":1},\"in_read\":48081,\"out_read\":48081},{\"message\":{\"id\":48080,\"date\":1468346258,\"out\":1,\"user_id\":115482101,\"read_state\":1,\"title\":\"\",\"body\":\"спасибо\",\"random_id\":0},\"in_read\":48080,\"out_read\":48080},{\"message\":{\"id\":47527,\"date\":1464190024,\"out\":0,\"user_id\":275910165,\"read_state\":1,\"title\":\"\",\"body\":\":)\"},\"in_read\":47527,\"out_read\":47527},{\"message\":{\"id\":40367,\"date\":1460372680,\"out\":0,\"user_id\":22321904,\"read_state\":1,\"title\":\"\",\"body\":\"окъ\"},\"in_read\":40367,\"out_read\":40367},{\"message\":{\"id\":39795,\"date\":1454430308,\"out\":1,\"user_id\":6482848,\"read_state\":1,\"title\":\"\",\"body\":\"Да спасибо. Ты сам щас где?\",\"random_id\":0},\"in_read\":39795,\"out_read\":39795},{\"message\":{\"id\":37633,\"date\":1440438292,\"out\":0,\"user_id\":18174552,\"read_state\":1,\"title\":\"\",\"body\":\"Валеруан пожалуйста мой номер +375292230111 а номер деда +375298080022\"},\"in_read\":37633,\"out_read\":37633},{\"message\":{\"id\":37310,\"date\":1439371772,\"out\":0,\"user_id\":70921241,\"read_state\":1,\"title\":\"\",\"body\":\"не помню какой сейчас у него,но все его\"},\"in_read\":37310,\"out_read\":37310},{\"message\":{\"id\":36171,\"date\":1438367711,\"out\":1,\"user_id\":5626533,\"read_state\":1,\"title\":\"\",\"body\":\"Спасибо\",\"random_id\":0},\"in_read\":36171,\"out_read\":36171},{\"message\":{\"id\":33912,\"date\":1436635028,\"out\":1,\"user_id\":12971303,\"read_state\":1,\"title\":\"\",\"body\":\"да \\nразвлекаемся тут как можем)\",\"random_id\":0},\"in_read\":33912,\"out_read\":33912},{\"message\":{\"id\":33566,\"date\":1436122400,\"out\":0,\"user_id\":13184810,\"read_state\":1,\"title\":\"\",\"body\":\"Ок\"},\"in_read\":33566,\"out_read\":33566},{\"message\":{\"id\":31911,\"date\":1432384336,\"out\":0,\"user_id\":16204912,\"read_state\":1,\"title\":\"\",\"body\":\"и у меня тоже самое так что надо потом соглосовать куда ехоть)))))\"},\"in_read\":31911,\"out_read\":31911},{\"message\":{\"id\":31517,\"date\":1431625391,\"out\":1,\"user_id\":246413298,\"read_state\":1,\"title\":\"\",\"body\":\"Сэнкс\",\"random_id\":0},\"in_read\":31517,\"out_read\":31517},{\"message\":{\"id\":31512,\"date\":1431519388,\"out\":1,\"user_id\":52794476,\"read_state\":1,\"title\":\"\",\"body\":\"Спасибо\",\"random_id\":0},\"in_read\":31512,\"out_read\":31512},{\"message\":{\"id\":30990,\"date\":1424776612,\"out\":0,\"user_id\":14790669,\"read_state\":1,\"title\":\"\",\"body\":\"Здорова))+375 (29) 319-00-58\"},\"in_read\":30990,\"out_read\":30990},{\"message\":{\"id\":26721,\"date\":1407514120,\"out\":1,\"user_id\":13856056,\"read_state\":1,\"title\":\"\",\"body\":\"50 в ваших программках и 1 в ваших сердцах))\\n+375259875947\",\"random_id\":0},\"in_read\":26721,\"out_read\":26721}]}}";
        httpsGetter = mock(HttpsGetter.class);
        when(httpsGetter.get(targetUrl)).thenReturn(expectedJson);
        vk = new VkMethods(httpsGetter, securityToken, userId);
        String actualJson = new Gson().toJson(vk.getDialogs(201));

        expectedJson = "[{\"unread\":3,\"message\":{\"id\":53010,\"user_id\":17193224,\"from_id\":0,\"date\":1521375264,\"read_state\":0,\"out\":0,\"title\":\"\",\"body\":\"Зарегистрируйтесь на Airbnb и получите скидку $35 на первое приключение. Вот моя ссылка с приглашением: https://abnb.me/e/ftK7OJmZnL\",\"emoji\":0,\"deleted\":0}},{\"unread\":0,\"message\":{\"id\":53007,\"user_id\":204437607,\"from_id\":0,\"date\":1520982614,\"read_state\":1,\"out\":0,\"title\":\"\",\"body\":\"he\",\"emoji\":0,\"deleted\":0}},{\"unread\":0,\"message\":{\"id\":52997,\"user_id\":1253301,\"from_id\":0,\"date\":1520675935,\"read_state\":1,\"out\":1,\"title\":\"\",\"body\":\"чтоб я чартер заказывал)\",\"emoji\":0,\"deleted\":0}},{\"unread\":0,\"message\":{\"id\":52925,\"user_id\":396899152,\"from_id\":0,\"date\":1519285055,\"read_state\":1,\"out\":0,\"title\":\"\",\"body\":\"Здравствуйте. В субботу в 15.00 запланировано занятие. У Вас получится его посетить?\",\"emoji\":0,\"deleted\":0}},{\"unread\":0,\"message\":{\"id\":52894,\"user_id\":84355724,\"from_id\":0,\"date\":1512926340,\"read_state\":1,\"out\":1,\"title\":\"\",\"body\":\"ок определюсь на днях\",\"emoji\":0,\"deleted\":0}},{\"unread\":0,\"message\":{\"id\":52844,\"user_id\":90928490,\"from_id\":0,\"date\":1511623453,\"read_state\":1,\"out\":0,\"title\":\"\",\"body\":\"чуть позже гляну)\",\"emoji\":0,\"deleted\":0}},{\"unread\":0,\"message\":{\"id\":52833,\"user_id\":137268284,\"from_id\":0,\"date\":1511198591,\"read_state\":1,\"out\":0,\"title\":\"\",\"body\":\"Да ))\",\"emoji\":0,\"deleted\":0}},{\"unread\":0,\"message\":{\"id\":52762,\"user_id\":286244973,\"from_id\":0,\"date\":1510830380,\"read_state\":1,\"out\":0,\"title\":\"\",\"body\":\"А сегодня будет вратарьская\",\"emoji\":0,\"deleted\":0}},{\"unread\":0,\"message\":{\"id\":52754,\"user_id\":16377310,\"from_id\":0,\"date\":1510299800,\"read_state\":1,\"out\":0,\"title\":\"\",\"body\":\"Хорошо\",\"emoji\":0,\"deleted\":0}},{\"unread\":0,\"message\":{\"id\":52739,\"user_id\":69377648,\"from_id\":0,\"date\":1509777876,\"read_state\":1,\"out\":1,\"title\":\"\",\"body\":\"как то так знаю это странно\\nно бля я же басист в конце концов\",\"emoji\":0,\"deleted\":0}},{\"unread\":0,\"message\":{\"id\":52680,\"user_id\":181244406,\"from_id\":0,\"date\":1506373105,\"read_state\":1,\"out\":1,\"title\":\"\",\"body\":\"спс бро\",\"emoji\":0,\"deleted\":0}},{\"unread\":0,\"message\":{\"id\":52511,\"user_id\":63442680,\"from_id\":0,\"date\":1505727892,\"read_state\":1,\"out\":1,\"title\":\"\",\"body\":\"Дэбил чтоли со своей учетки клюшки впаривать ))))\",\"emoji\":0,\"deleted\":0}},{\"unread\":0,\"message\":{\"id\":52509,\"user_id\":6918214,\"from_id\":0,\"date\":1502371985,\"read_state\":1,\"out\":1,\"title\":\"\",\"body\":\"https://drive.google.com/open?id\\u003d0B_I0NH8zJXt0Tl83U2NOOV90aUk\",\"emoji\":0,\"deleted\":0}},{\"unread\":0,\"message\":{\"id\":52241,\"user_id\":134160651,\"from_id\":0,\"date\":1483213246,\"read_state\":1,\"out\":0,\"title\":\"\",\"body\":\"Точно, и нового тебе шлема) с коброй золотой, как ты хотел)\",\"emoji\":0,\"deleted\":0}},{\"unread\":0,\"message\":{\"id\":52222,\"user_id\":225976680,\"from_id\":0,\"date\":1482940870,\"read_state\":1,\"out\":1,\"title\":\"\",\"body\":\"\",\"emoji\":0,\"deleted\":0}},{\"unread\":0,\"message\":{\"id\":52066,\"user_id\":3783801,\"from_id\":0,\"date\":1476454476,\"read_state\":1,\"out\":0,\"title\":\"\",\"body\":\"Привет , забыл ?)\",\"emoji\":0,\"deleted\":0}},{\"unread\":0,\"message\":{\"id\":51473,\"user_id\":374417194,\"from_id\":0,\"date\":1475221010,\"read_state\":0,\"out\":1,\"title\":\"\",\"body\":\"Привет Вентиль с днюхой тебя !\",\"emoji\":0,\"deleted\":0}},{\"unread\":0,\"message\":{\"id\":48081,\"user_id\":110938977,\"from_id\":0,\"date\":1468348590,\"read_state\":1,\"out\":0,\"title\":\"\",\"body\":\"\uD83D\uDE0A\",\"emoji\":1,\"deleted\":0}},{\"unread\":0,\"message\":{\"id\":48080,\"user_id\":115482101,\"from_id\":0,\"date\":1468346258,\"read_state\":1,\"out\":1,\"title\":\"\",\"body\":\"спасибо\",\"emoji\":0,\"deleted\":0}},{\"unread\":0,\"message\":{\"id\":47527,\"user_id\":275910165,\"from_id\":0,\"date\":1464190024,\"read_state\":1,\"out\":0,\"title\":\"\",\"body\":\":)\",\"emoji\":0,\"deleted\":0}},{\"unread\":0,\"message\":{\"id\":40367,\"user_id\":22321904,\"from_id\":0,\"date\":1460372680,\"read_state\":1,\"out\":0,\"title\":\"\",\"body\":\"окъ\",\"emoji\":0,\"deleted\":0}},{\"unread\":0,\"message\":{\"id\":39795,\"user_id\":6482848,\"from_id\":0,\"date\":1454430308,\"read_state\":1,\"out\":1,\"title\":\"\",\"body\":\"Да спасибо. Ты сам щас где?\",\"emoji\":0,\"deleted\":0}},{\"unread\":0,\"message\":{\"id\":37633,\"user_id\":18174552,\"from_id\":0,\"date\":1440438292,\"read_state\":1,\"out\":0,\"title\":\"\",\"body\":\"Валеруан пожалуйста мой номер +375292230111 а номер деда +375298080022\",\"emoji\":0,\"deleted\":0}},{\"unread\":0,\"message\":{\"id\":37310,\"user_id\":70921241,\"from_id\":0,\"date\":1439371772,\"read_state\":1,\"out\":0,\"title\":\"\",\"body\":\"не помню какой сейчас у него,но все его\",\"emoji\":0,\"deleted\":0}},{\"unread\":0,\"message\":{\"id\":36171,\"user_id\":5626533,\"from_id\":0,\"date\":1438367711,\"read_state\":1,\"out\":1,\"title\":\"\",\"body\":\"Спасибо\",\"emoji\":0,\"deleted\":0}},{\"unread\":0,\"message\":{\"id\":33912,\"user_id\":12971303,\"from_id\":0,\"date\":1436635028,\"read_state\":1,\"out\":1,\"title\":\"\",\"body\":\"да \\nразвлекаемся тут как можем)\",\"emoji\":0,\"deleted\":0}},{\"unread\":0,\"message\":{\"id\":33566,\"user_id\":13184810,\"from_id\":0,\"date\":1436122400,\"read_state\":1,\"out\":0,\"title\":\"\",\"body\":\"Ок\",\"emoji\":0,\"deleted\":0}},{\"unread\":0,\"message\":{\"id\":31911,\"user_id\":16204912,\"from_id\":0,\"date\":1432384336,\"read_state\":1,\"out\":0,\"title\":\"\",\"body\":\"и у меня тоже самое так что надо потом соглосовать куда ехоть)))))\",\"emoji\":0,\"deleted\":0}},{\"unread\":0,\"message\":{\"id\":31517,\"user_id\":246413298,\"from_id\":0,\"date\":1431625391,\"read_state\":1,\"out\":1,\"title\":\"\",\"body\":\"Сэнкс\",\"emoji\":0,\"deleted\":0}},{\"unread\":0,\"message\":{\"id\":31512,\"user_id\":52794476,\"from_id\":0,\"date\":1431519388,\"read_state\":1,\"out\":1,\"title\":\"\",\"body\":\"Спасибо\",\"emoji\":0,\"deleted\":0}},{\"unread\":0,\"message\":{\"id\":30990,\"user_id\":14790669,\"from_id\":0,\"date\":1424776612,\"read_state\":1,\"out\":0,\"title\":\"\",\"body\":\"Здорова))+375 (29) 319-00-58\",\"emoji\":0,\"deleted\":0}},{\"unread\":0,\"message\":{\"id\":26721,\"user_id\":13856056,\"from_id\":0,\"date\":1407514120,\"read_state\":1,\"out\":1,\"title\":\"\",\"body\":\"50 в ваших программках и 1 в ваших сердцах))\\n+375259875947\",\"emoji\":0,\"deleted\":0}}]";
        assertEquals(expectedJson, actualJson);
    }

    @Test
    public void getDialogs_CountFour_returns4Dialogs() throws IOException {
        String targetUrl = "https://api.vk.com/method/messages.getDialogs?access_token=9bdcf2fa1612d472284d519d6473f7b8e98498362438b03ecf542f74461fe25c7e15c89ba8d311b5e94b8&v=5.52&count=4";
        String expectedJson = "{\"response\":{\"count\":32,\"unread_dialogs\":1,\"items\":[{\"unread\":3,\"message\":{\"id\":53010,\"date\":1521375264,\"out\":0,\"user_id\":17193224,\"read_state\":0,\"title\":\"\",\"body\":\"Зарегистрируйтесь на Airbnb и получите скидку $35 на первое приключение. Вот моя ссылка с приглашением: https:\\/\\/abnb.me\\/e\\/ftK7OJmZnL\"},\"in_read\":53002,\"out_read\":53010},{\"message\":{\"id\":53007,\"date\":1520982614,\"out\":0,\"user_id\":204437607,\"read_state\":1,\"title\":\"\",\"body\":\"he\",\"random_id\":0},\"in_read\":53007,\"out_read\":53007},{\"message\":{\"id\":52997,\"date\":1520675935,\"out\":1,\"user_id\":1253301,\"read_state\":1,\"title\":\"\",\"body\":\"чтоб я чартер заказывал)\",\"random_id\":1245455915},\"in_read\":52997,\"out_read\":52997},{\"message\":{\"id\":52925,\"date\":1519285055,\"out\":0,\"user_id\":396899152,\"read_state\":1,\"title\":\"\",\"body\":\"Здравствуйте. В субботу в 15.00 запланировано занятие. У Вас получится его посетить?\"},\"in_read\":52925,\"out_read\":52925}]}}";

        httpsGetter = mock(HttpsGetter.class);
        when(httpsGetter.get(targetUrl)).thenReturn(expectedJson);

        vk = new VkMethods(httpsGetter, securityToken, userId);
        String actualJson = new Gson().toJson(vk.getDialogs(4));

        expectedJson = "[{\"unread\":3,\"message\":{\"id\":53010,\"user_id\":17193224,\"from_id\":0,\"date\":1521375264,\"read_state\":0,\"out\":0,\"title\":\"\",\"body\":\"Зарегистрируйтесь на Airbnb и получите скидку $35 на первое приключение. Вот моя ссылка с приглашением: https://abnb.me/e/ftK7OJmZnL\",\"emoji\":0,\"deleted\":0}},{\"unread\":0,\"message\":{\"id\":53007,\"user_id\":204437607,\"from_id\":0,\"date\":1520982614,\"read_state\":1,\"out\":0,\"title\":\"\",\"body\":\"he\",\"emoji\":0,\"deleted\":0}},{\"unread\":0,\"message\":{\"id\":52997,\"user_id\":1253301,\"from_id\":0,\"date\":1520675935,\"read_state\":1,\"out\":1,\"title\":\"\",\"body\":\"чтоб я чартер заказывал)\",\"emoji\":0,\"deleted\":0}},{\"unread\":0,\"message\":{\"id\":52925,\"user_id\":396899152,\"from_id\":0,\"date\":1519285055,\"read_state\":1,\"out\":0,\"title\":\"\",\"body\":\"Здравствуйте. В субботу в 15.00 запланировано занятие. У Вас получится его посетить?\",\"emoji\":0,\"deleted\":0}}]";
        assertEquals(expectedJson, actualJson);
    }

    @Test
    public void getMessageHistory_negativeOffset_ZeroOffset() throws IOException {
        String targetUrl = "https://api.vk.com/method/messages.getHistory?access_token=9bdcf2fa1612d472284d519d6473f7b8e98498362438b03ecf542f74461fe25c7e15c89ba8d311b5e94b8&v=5.52&offset=0&count=4&user_id=204437607";
        String expectedJson = "{\"response\":{\"count\":46,\"items\":[{\"id\":53007,\"body\":\"he\",\"user_id\":204437607,\"from_id\":204437607,\"date\":1520982614,\"read_state\":1,\"out\":0,\"random_id\":0},{\"id\":53006,\"body\":\"ооллень\",\"user_id\":204437607,\"from_id\":204437607,\"date\":1520982064,\"read_state\":1,\"out\":0,\"random_id\":0},{\"id\":53005,\"body\":\"abcdefg\",\"user_id\":204437607,\"from_id\":204437607,\"date\":1520981396,\"read_state\":1,\"out\":0,\"random_id\":0},{\"id\":53004,\"body\":\"abcdefg\",\"user_id\":204437607,\"from_id\":204437607,\"date\":1520932979,\"read_state\":1,\"out\":0,\"random_id\":0}],\"in_read\":53007,\"out_read\":53007}}";

        httpsGetter = mock(HttpsGetter.class);
        when(httpsGetter.get(targetUrl)).thenReturn(expectedJson);

        vk = new VkMethods(httpsGetter, securityToken, userId);
        int uid = Integer.parseInt(userId);
        String actualJson = new Gson().toJson(vk.getMessageHistory(-1, 4, uid));

        expectedJson = "{\"count\":46,\"items\":[{\"id\":53007,\"user_id\":204437607,\"from_id\":204437607,\"date\":1520982614,\"read_state\":1,\"out\":0,\"body\":\"he\",\"emoji\":0,\"deleted\":0},{\"id\":53006,\"user_id\":204437607,\"from_id\":204437607,\"date\":1520982064,\"read_state\":1,\"out\":0,\"body\":\"ооллень\",\"emoji\":0,\"deleted\":0},{\"id\":53005,\"user_id\":204437607,\"from_id\":204437607,\"date\":1520981396,\"read_state\":1,\"out\":0,\"body\":\"abcdefg\",\"emoji\":0,\"deleted\":0},{\"id\":53004,\"user_id\":204437607,\"from_id\":204437607,\"date\":1520932979,\"read_state\":1,\"out\":0,\"body\":\"abcdefg\",\"emoji\":0,\"deleted\":0}]}";
        assertEquals(expectedJson, actualJson);


    }

    @Test
    public void getMessageHistory_negativeCount_OneMessage() throws IOException {
        String targetUrl = "https://api.vk.com/method/messages.getHistory?access_token=9bdcf2fa1612d472284d519d6473f7b8e98498362438b03ecf542f74461fe25c7e15c89ba8d311b5e94b8&v=5.52&offset=0&count=1&user_id=204437607";
        String expectedJson = "{\"response\":{\"count\":46,\"items\":[{\"id\":53007,\"body\":\"he\",\"user_id\":204437607,\"from_id\":204437607,\"date\":1520982614,\"read_state\":1,\"out\":0,\"random_id\":0}],\"in_read\":53007,\"out_read\":53007}}";

        httpsGetter = mock(HttpsGetter.class);
        when(httpsGetter.get(targetUrl)).thenReturn(expectedJson);

        vk = new VkMethods(httpsGetter, securityToken, userId);
        int uid = Integer.parseInt(userId);
        String actualJson = new Gson().toJson(vk.getMessageHistory(0, -1, uid));

        expectedJson = "{\"count\":46,\"items\":[{\"id\":53007,\"user_id\":204437607,\"from_id\":204437607,\"date\":1520982614,\"read_state\":1,\"out\":0,\"body\":\"he\",\"emoji\":0,\"deleted\":0}]}";
        assertEquals(expectedJson, actualJson);
    }

    @Test
    public void getMessageHistory_countBiggerThen200_maxAllowedMessages200() throws IOException {
        String targetUrl = "https://api.vk.com/method/messages.getHistory?access_token=9bdcf2fa1612d472284d519d6473f7b8e98498362438b03ecf542f74461fe25c7e15c89ba8d311b5e94b8&v=5.52&offset=0&count=200&user_id=204437607";
        String expectedJson = "{\"response\":{\"count\":46,\"items\":[{\"id\":53007,\"body\":\"he\",\"user_id\":204437607,\"from_id\":204437607,\"date\":1520982614,\"read_state\":1,\"out\":0,\"random_id\":0},{\"id\":53006,\"body\":\"ооллень\",\"user_id\":204437607,\"from_id\":204437607,\"date\":1520982064,\"read_state\":1,\"out\":0,\"random_id\":0},{\"id\":53005,\"body\":\"abcdefg\",\"user_id\":204437607,\"from_id\":204437607,\"date\":1520981396,\"read_state\":1,\"out\":0,\"random_id\":0},{\"id\":53004,\"body\":\"abcdefg\",\"user_id\":204437607,\"from_id\":204437607,\"date\":1520932979,\"read_state\":1,\"out\":0,\"random_id\":0},{\"id\":53003,\"body\":\"abcdefg\",\"user_id\":204437607,\"from_id\":204437607,\"date\":1520932478,\"read_state\":1,\"out\":0,\"random_id\":0},{\"id\":52993,\"body\":\"fuck me\",\"user_id\":204437607,\"from_id\":204437607,\"date\":1520642991,\"read_state\":1,\"out\":0,\"random_id\":0},{\"id\":52992,\"body\":\"fuck me\",\"user_id\":204437607,\"from_id\":204437607,\"date\":1520642894,\"read_state\":1,\"out\":0,\"random_id\":0},{\"id\":52935,\"body\":\"abcdefg\",\"user_id\":204437607,\"from_id\":204437607,\"date\":1519671604,\"read_state\":1,\"out\":0,\"random_id\":0},{\"id\":52934,\"body\":\"abcdefg\",\"user_id\":204437607,\"from_id\":204437607,\"date\":1519604127,\"read_state\":1,\"out\":0,\"random_id\":0},{\"id\":52933,\"body\":\"abcdefg\",\"user_id\":204437607,\"from_id\":204437607,\"date\":1519603988,\"read_state\":1,\"out\":0,\"random_id\":0},{\"id\":52932,\"body\":\"abcdefg\",\"user_id\":204437607,\"from_id\":204437607,\"date\":1519603976,\"read_state\":1,\"out\":0,\"random_id\":0},{\"id\":52931,\"body\":\"abcdefg\",\"user_id\":204437607,\"from_id\":204437607,\"date\":1519603935,\"read_state\":1,\"out\":0,\"random_id\":0},{\"id\":52930,\"body\":\"abcdefg\",\"user_id\":204437607,\"from_id\":204437607,\"date\":1519603919,\"read_state\":1,\"out\":0,\"random_id\":0},{\"id\":52929,\"body\":\"abcdefg\",\"user_id\":204437607,\"from_id\":204437607,\"date\":1519603903,\"read_state\":1,\"out\":0,\"random_id\":0},{\"id\":52928,\"body\":\"abcdefg\",\"user_id\":204437607,\"from_id\":204437607,\"date\":1519603873,\"read_state\":1,\"out\":0,\"random_id\":0},{\"id\":52924,\"body\":\"today\",\"user_id\":204437607,\"from_id\":204437607,\"date\":1518763479,\"read_state\":1,\"out\":0,\"random_id\":0},{\"id\":52923,\"body\":\"Test\",\"user_id\":204437607,\"from_id\":204437607,\"date\":1518597389,\"read_state\":1,\"out\":0,\"random_id\":0},{\"id\":52922,\"body\":\"Ma fucka n\",\"user_id\":204437607,\"from_id\":204437607,\"date\":1518596169,\"read_state\":1,\"out\":0,\"random_id\":0},{\"id\":52921,\"body\":\"Peace man\",\"user_id\":204437607,\"from_id\":204437607,\"date\":1518595864,\"read_state\":1,\"out\":0,\"random_id\":0},{\"id\":52920,\"body\":\"Yao\",\"user_id\":204437607,\"from_id\":204437607,\"date\":1518595785,\"read_state\":1,\"out\":0,\"random_id\":0},{\"id\":52919,\"body\":\"Hello\",\"user_id\":204437607,\"from_id\":204437607,\"date\":1518595449,\"read_state\":1,\"out\":0,\"random_id\":0},{\"id\":52918,\"body\":\"Po\",\"user_id\":204437607,\"from_id\":204437607,\"date\":1518595395,\"read_state\":1,\"out\":0,\"random_id\":0},{\"id\":52917,\"body\":\"Hello\",\"user_id\":204437607,\"from_id\":204437607,\"date\":1518595393,\"read_state\":1,\"out\":0,\"random_id\":0},{\"id\":52916,\"body\":\"Hello Po\",\"user_id\":204437607,\"from_id\":204437607,\"date\":1518595362,\"read_state\":1,\"out\":0,\"random_id\":0},{\"id\":52915,\"body\":\"kkkk\\nggg\",\"user_id\":204437607,\"from_id\":204437607,\"date\":1518593677,\"read_state\":1,\"out\":0,\"random_id\":0},{\"id\":52914,\"body\":\"kkkk\\nggg\",\"user_id\":204437607,\"from_id\":204437607,\"date\":1518592672,\"read_state\":1,\"out\":0,\"random_id\":0},{\"id\":52913,\"body\":\"Hello this is test message\",\"user_id\":204437607,\"from_id\":204437607,\"date\":1518592558,\"read_state\":1,\"out\":0,\"random_id\":0},{\"id\":52912,\"body\":\"Hello this is test message\",\"user_id\":204437607,\"from_id\":204437607,\"date\":1518591413,\"read_state\":1,\"out\":0,\"random_id\":0},{\"id\":52911,\"body\":\"Hello hello\",\"user_id\":204437607,\"from_id\":204437607,\"date\":1518591367,\"read_state\":1,\"out\":0,\"random_id\":0},{\"id\":52910,\"body\":\"\\\"Hello hello\\\"\",\"user_id\":204437607,\"from_id\":204437607,\"date\":1518591348,\"read_state\":1,\"out\":0,\"random_id\":0},{\"id\":52909,\"body\":\"Hello\",\"user_id\":204437607,\"from_id\":204437607,\"date\":1518591170,\"read_state\":1,\"out\":0,\"random_id\":0},{\"id\":52902,\"body\":\"test message\",\"user_id\":204437607,\"from_id\":204437607,\"date\":1517169989,\"read_state\":1,\"out\":0,\"random_id\":0},{\"id\":52901,\"body\":\"\\\"test message\\\"\",\"user_id\":204437607,\"from_id\":204437607,\"date\":1517169952,\"read_state\":1,\"out\":0,\"random_id\":0},{\"id\":52896,\"body\":\"http:\\/\\/depositfiles.com\\/files\\/nbzfgh6i7\",\"user_id\":204437607,\"from_id\":204437607,\"date\":1515927049,\"read_state\":1,\"out\":0,\"random_id\":0},{\"id\":52895,\"body\":\"Фирма \\\"Автореабилитация\\\" д.Сеница производили ремонт VolksWagen LT (пескоструйка , переварка, антикоррозийная обработка). \\nРаботы выполнены неудовлетворительно, в кустарный условиях за очень приличные деньги . На их сайте модератор не пропускает \\nплохие отзывы . Действительность не соответствует ожиданию . \\n \\nПРОЕЗЖАЙТЕ МИМО !!!\",\"user_id\":204437607,\"from_id\":204437607,\"date\":1514794148,\"read_state\":1,\"out\":0,\"random_id\":1845990085},{\"id\":52839,\"body\":\"\",\"user_id\":204437607,\"from_id\":204437607,\"date\":1511367159,\"read_state\":1,\"out\":0,\"random_id\":2087981845,\"attachments\":[{\"type\":\"photo\",\"photo\":{\"id\":456239103,\"album_id\":-3,\"owner_id\":204437607,\"photo_75\":\"https:\\/\\/sun9-2.userapi.com\\/c834402\\/v834402088\\/328c5\\/4B_yhcs1Gog.jpg\",\"photo_130\":\"https:\\/\\/sun9-8.userapi.com\\/c834402\\/v834402088\\/328c6\\/YZZv7O6oAnY.jpg\",\"photo_604\":\"https:\\/\\/sun9-5.userapi.com\\/c834402\\/v834402088\\/328c7\\/AvW3mVGc9Qo.jpg\",\"photo_807\":\"https:\\/\\/sun9-7.userapi.com\\/c834402\\/v834402088\\/328c8\\/JXx3c-DUgmg.jpg\",\"photo_1280\":\"https:\\/\\/sun9-8.userapi.com\\/c834402\\/v834402088\\/328c9\\/GlzvnrN40CQ.jpg\",\"photo_2560\":\"https:\\/\\/sun9-1.userapi.com\\/c834402\\/v834402088\\/328ca\\/kxcz2jNQhDY.jpg\",\"width\":1366,\"height\":768,\"text\":\"\",\"date\":1511366180,\"access_key\":\"5763a0a434712047f3\"}},{\"type\":\"photo\",\"photo\":{\"id\":456239104,\"album_id\":-3,\"owner_id\":204437607,\"photo_75\":\"https:\\/\\/sun9-3.userapi.com\\/c824410\\/v824410731\\/33cc2\\/iVthZZIOywo.jpg\",\"photo_130\":\"https:\\/\\/sun9-6.userapi.com\\/c824410\\/v824410731\\/33cc3\\/id-P0aEPeqQ.jpg\",\"photo_604\":\"https:\\/\\/sun9-7.userapi.com\\/c824410\\/v824410731\\/33cc4\\/nYUb0WWNKMg.jpg\",\"photo_807\":\"https:\\/\\/sun9-1.userapi.com\\/c824410\\/v824410731\\/33cc5\\/8px3rDN6auY.jpg\",\"photo_1280\":\"https:\\/\\/sun9-4.userapi.com\\/c824410\\/v824410731\\/33cc6\\/sAqc76Nn0Xg.jpg\",\"photo_2560\":\"https:\\/\\/sun9-9.userapi.com\\/c824410\\/v824410731\\/33cc7\\/A3-wEz2iVSc.jpg\",\"width\":1366,\"height\":768,\"text\":\"\",\"date\":1511367159,\"access_key\":\"51df63302f4fc7cce5\"}}]},{\"id\":52728,\"body\":\"3270953\",\"user_id\":204437607,\"from_id\":204437607,\"date\":1509694651,\"read_state\":1,\"out\":0,\"random_id\":1857316325},{\"id\":52725,\"body\":\"faust58@TUT.BY \\n \\nФИО \\nВИД СПОРТА \\nГДЕ УЧАСТВОВАЛ В СОСТАВЕ СБОРНОЙ \\nМЕСТО ПРОВИДЕНИЯ И ДАТА \\nМОБ ТЕЛ \\n \\nПодпись\",\"user_id\":204437607,\"from_id\":204437607,\"date\":1509694429,\"read_state\":1,\"out\":0,\"random_id\":1812666177},{\"id\":52706,\"body\":\"https:\\/\\/4service.shopmetrics.com\\/document.asp?alias=survey.view&ShowSummary=true&InstanceID=5074370\",\"user_id\":204437607,\"from_id\":204437607,\"date\":1507143226,\"read_state\":1,\"out\":0,\"random_id\":1784191414},{\"id\":52506,\"body\":\"\",\"user_id\":204437607,\"from_id\":204437607,\"date\":1500908516,\"read_state\":1,\"out\":0,\"random_id\":1854285301,\"attachments\":[{\"type\":\"link\",\"link\":{\"url\":\"http:\\/\\/meetup.by\\/event\\/2017-07-17\\/coding-fest\",\"title\":\"Coding Fest | Meetup BY\",\"caption\":\"meetup.by\",\"description\":\"\",\"is_external\":0,\"photo\":{\"id\":456249863,\"album_id\":-27,\"owner_id\":100,\"photo_75\":\"https:\\/\\/pp.userapi.com\\/c840136\\/v840136887\\/12dd7\\/ATp8zXcUI_Q.jpg\",\"photo_130\":\"https:\\/\\/pp.userapi.com\\/c840136\\/v840136887\\/12dd8\\/zvFkFpwbP3Q.jpg\",\"photo_604\":\"https:\\/\\/pp.userapi.com\\/c840136\\/v840136887\\/12dd9\\/_3C8MvQMcMc.jpg\",\"width\":200,\"height\":106,\"text\":\"\",\"date\":1500908516}}}]},{\"id\":52505,\"body\":\"https:\\/\\/imaguru.by\",\"user_id\":204437607,\"from_id\":204437607,\"date\":1500908495,\"read_state\":1,\"out\":0,\"random_id\":993894462},{\"id\":52453,\"body\":\"https:\\/\\/youtu.be\\/hUmkiLeWfJY?t=1751\",\"user_id\":204437607,\"from_id\":204437607,\"date\":1497977813,\"read_state\":1,\"out\":0,\"random_id\":760670243},{\"id\":52451,\"body\":\"ANDREI:00253200\\n modem78:11254245\\n modem89:00252989\",\"user_id\":204437607,\"from_id\":204437607,\"date\":1497432192,\"read_state\":1,\"out\":0,\"random_id\":1022678310},{\"id\":52272,\"body\":\"http:\\/\\/macappstore.org\\/hashcat\\/\",\"user_id\":204437607,\"from_id\":204437607,\"date\":1489394963,\"read_state\":1,\"out\":0,\"random_id\":1005870245},{\"id\":52261,\"body\":\"\",\"user_id\":204437607,\"from_id\":204437607,\"date\":1489394703,\"read_state\":1,\"out\":0,\"random_id\":1670112961,\"attachments\":[{\"type\":\"link\",\"link\":{\"url\":\"https:\\/\\/hashcat.net\\/forum\\/thread-5594-page-2.html\",\"title\":\"hashcat v3 macOS\",\"caption\":\"hashcat.net\",\"description\":\"\",\"is_external\":0}}]},{\"id\":52258,\"body\":\"\",\"user_id\":204437607,\"from_id\":204437607,\"date\":1489390604,\"read_state\":1,\"out\":0,\"random_id\":489326281,\"attachments\":[{\"type\":\"link\",\"link\":{\"url\":\"http:\\/\\/airslax.com\\/wpa2\\/\",\"title\":\"AirSlax.com\",\"caption\":\"airslax.com\",\"description\":\"Подбор WiFi пароля WPA\\/WPA2.\",\"is_external\":0}}]}],\"in_read\":53007,\"out_read\":53007}}";

        httpsGetter = mock(HttpsGetter.class);
        when(httpsGetter.get(targetUrl)).thenReturn(expectedJson);

        vk = new VkMethods(httpsGetter, securityToken, userId);
        int uid = Integer.parseInt(userId);
        String actualJson = new Gson().toJson(vk.getMessageHistory(0, 2001, uid));

        expectedJson = "{\"count\":46,\"items\":[{\"id\":53007,\"user_id\":204437607,\"from_id\":204437607,\"date\":1520982614,\"read_state\":1,\"out\":0,\"body\":\"he\",\"emoji\":0,\"deleted\":0},{\"id\":53006,\"user_id\":204437607,\"from_id\":204437607,\"date\":1520982064,\"read_state\":1,\"out\":0,\"body\":\"ооллень\",\"emoji\":0,\"deleted\":0},{\"id\":53005,\"user_id\":204437607,\"from_id\":204437607,\"date\":1520981396,\"read_state\":1,\"out\":0,\"body\":\"abcdefg\",\"emoji\":0,\"deleted\":0},{\"id\":53004,\"user_id\":204437607,\"from_id\":204437607,\"date\":1520932979,\"read_state\":1,\"out\":0,\"body\":\"abcdefg\",\"emoji\":0,\"deleted\":0},{\"id\":53003,\"user_id\":204437607,\"from_id\":204437607,\"date\":1520932478,\"read_state\":1,\"out\":0,\"body\":\"abcdefg\",\"emoji\":0,\"deleted\":0},{\"id\":52993,\"user_id\":204437607,\"from_id\":204437607,\"date\":1520642991,\"read_state\":1,\"out\":0,\"body\":\"fuck me\",\"emoji\":0,\"deleted\":0},{\"id\":52992,\"user_id\":204437607,\"from_id\":204437607,\"date\":1520642894,\"read_state\":1,\"out\":0,\"body\":\"fuck me\",\"emoji\":0,\"deleted\":0},{\"id\":52935,\"user_id\":204437607,\"from_id\":204437607,\"date\":1519671604,\"read_state\":1,\"out\":0,\"body\":\"abcdefg\",\"emoji\":0,\"deleted\":0},{\"id\":52934,\"user_id\":204437607,\"from_id\":204437607,\"date\":1519604127,\"read_state\":1,\"out\":0,\"body\":\"abcdefg\",\"emoji\":0,\"deleted\":0},{\"id\":52933,\"user_id\":204437607,\"from_id\":204437607,\"date\":1519603988,\"read_state\":1,\"out\":0,\"body\":\"abcdefg\",\"emoji\":0,\"deleted\":0},{\"id\":52932,\"user_id\":204437607,\"from_id\":204437607,\"date\":1519603976,\"read_state\":1,\"out\":0,\"body\":\"abcdefg\",\"emoji\":0,\"deleted\":0},{\"id\":52931,\"user_id\":204437607,\"from_id\":204437607,\"date\":1519603935,\"read_state\":1,\"out\":0,\"body\":\"abcdefg\",\"emoji\":0,\"deleted\":0},{\"id\":52930,\"user_id\":204437607,\"from_id\":204437607,\"date\":1519603919,\"read_state\":1,\"out\":0,\"body\":\"abcdefg\",\"emoji\":0,\"deleted\":0},{\"id\":52929,\"user_id\":204437607,\"from_id\":204437607,\"date\":1519603903,\"read_state\":1,\"out\":0,\"body\":\"abcdefg\",\"emoji\":0,\"deleted\":0},{\"id\":52928,\"user_id\":204437607,\"from_id\":204437607,\"date\":1519603873,\"read_state\":1,\"out\":0,\"body\":\"abcdefg\",\"emoji\":0,\"deleted\":0},{\"id\":52924,\"user_id\":204437607,\"from_id\":204437607,\"date\":1518763479,\"read_state\":1,\"out\":0,\"body\":\"today\",\"emoji\":0,\"deleted\":0},{\"id\":52923,\"user_id\":204437607,\"from_id\":204437607,\"date\":1518597389,\"read_state\":1,\"out\":0,\"body\":\"Test\",\"emoji\":0,\"deleted\":0},{\"id\":52922,\"user_id\":204437607,\"from_id\":204437607,\"date\":1518596169,\"read_state\":1,\"out\":0,\"body\":\"Ma fucka n\",\"emoji\":0,\"deleted\":0},{\"id\":52921,\"user_id\":204437607,\"from_id\":204437607,\"date\":1518595864,\"read_state\":1,\"out\":0,\"body\":\"Peace man\",\"emoji\":0,\"deleted\":0},{\"id\":52920,\"user_id\":204437607,\"from_id\":204437607,\"date\":1518595785,\"read_state\":1,\"out\":0,\"body\":\"Yao\",\"emoji\":0,\"deleted\":0},{\"id\":52919,\"user_id\":204437607,\"from_id\":204437607,\"date\":1518595449,\"read_state\":1,\"out\":0,\"body\":\"Hello\",\"emoji\":0,\"deleted\":0},{\"id\":52918,\"user_id\":204437607,\"from_id\":204437607,\"date\":1518595395,\"read_state\":1,\"out\":0,\"body\":\"Po\",\"emoji\":0,\"deleted\":0},{\"id\":52917,\"user_id\":204437607,\"from_id\":204437607,\"date\":1518595393,\"read_state\":1,\"out\":0,\"body\":\"Hello\",\"emoji\":0,\"deleted\":0},{\"id\":52916,\"user_id\":204437607,\"from_id\":204437607,\"date\":1518595362,\"read_state\":1,\"out\":0,\"body\":\"Hello Po\",\"emoji\":0,\"deleted\":0},{\"id\":52915,\"user_id\":204437607,\"from_id\":204437607,\"date\":1518593677,\"read_state\":1,\"out\":0,\"body\":\"kkkk\\nggg\",\"emoji\":0,\"deleted\":0},{\"id\":52914,\"user_id\":204437607,\"from_id\":204437607,\"date\":1518592672,\"read_state\":1,\"out\":0,\"body\":\"kkkk\\nggg\",\"emoji\":0,\"deleted\":0},{\"id\":52913,\"user_id\":204437607,\"from_id\":204437607,\"date\":1518592558,\"read_state\":1,\"out\":0,\"body\":\"Hello this is test message\",\"emoji\":0,\"deleted\":0},{\"id\":52912,\"user_id\":204437607,\"from_id\":204437607,\"date\":1518591413,\"read_state\":1,\"out\":0,\"body\":\"Hello this is test message\",\"emoji\":0,\"deleted\":0},{\"id\":52911,\"user_id\":204437607,\"from_id\":204437607,\"date\":1518591367,\"read_state\":1,\"out\":0,\"body\":\"Hello hello\",\"emoji\":0,\"deleted\":0},{\"id\":52910,\"user_id\":204437607,\"from_id\":204437607,\"date\":1518591348,\"read_state\":1,\"out\":0,\"body\":\"\\\"Hello hello\\\"\",\"emoji\":0,\"deleted\":0},{\"id\":52909,\"user_id\":204437607,\"from_id\":204437607,\"date\":1518591170,\"read_state\":1,\"out\":0,\"body\":\"Hello\",\"emoji\":0,\"deleted\":0},{\"id\":52902,\"user_id\":204437607,\"from_id\":204437607,\"date\":1517169989,\"read_state\":1,\"out\":0,\"body\":\"test message\",\"emoji\":0,\"deleted\":0},{\"id\":52901,\"user_id\":204437607,\"from_id\":204437607,\"date\":1517169952,\"read_state\":1,\"out\":0,\"body\":\"\\\"test message\\\"\",\"emoji\":0,\"deleted\":0},{\"id\":52896,\"user_id\":204437607,\"from_id\":204437607,\"date\":1515927049,\"read_state\":1,\"out\":0,\"body\":\"http://depositfiles.com/files/nbzfgh6i7\",\"emoji\":0,\"deleted\":0},{\"id\":52895,\"user_id\":204437607,\"from_id\":204437607,\"date\":1514794148,\"read_state\":1,\"out\":0,\"body\":\"Фирма \\\"Автореабилитация\\\" д.Сеница производили ремонт VolksWagen LT (пескоструйка , переварка, антикоррозийная обработка). \\nРаботы выполнены неудовлетворительно, в кустарный условиях за очень приличные деньги . На их сайте модератор не пропускает \\nплохие отзывы . Действительность не соответствует ожиданию . \\n \\nПРОЕЗЖАЙТЕ МИМО !!!\",\"emoji\":0,\"deleted\":0},{\"id\":52839,\"user_id\":204437607,\"from_id\":204437607,\"date\":1511367159,\"read_state\":1,\"out\":0,\"body\":\"\",\"emoji\":0,\"deleted\":0},{\"id\":52728,\"user_id\":204437607,\"from_id\":204437607,\"date\":1509694651,\"read_state\":1,\"out\":0,\"body\":\"3270953\",\"emoji\":0,\"deleted\":0},{\"id\":52725,\"user_id\":204437607,\"from_id\":204437607,\"date\":1509694429,\"read_state\":1,\"out\":0,\"body\":\"faust58@TUT.BY \\n \\nФИО \\nВИД СПОРТА \\nГДЕ УЧАСТВОВАЛ В СОСТАВЕ СБОРНОЙ \\nМЕСТО ПРОВИДЕНИЯ И ДАТА \\nМОБ ТЕЛ \\n \\nПодпись\",\"emoji\":0,\"deleted\":0},{\"id\":52706,\"user_id\":204437607,\"from_id\":204437607,\"date\":1507143226,\"read_state\":1,\"out\":0,\"body\":\"https://4service.shopmetrics.com/document.asp?alias\\u003dsurvey.view\\u0026ShowSummary\\u003dtrue\\u0026InstanceID\\u003d5074370\",\"emoji\":0,\"deleted\":0},{\"id\":52506,\"user_id\":204437607,\"from_id\":204437607,\"date\":1500908516,\"read_state\":1,\"out\":0,\"body\":\"\",\"emoji\":0,\"deleted\":0},{\"id\":52505,\"user_id\":204437607,\"from_id\":204437607,\"date\":1500908495,\"read_state\":1,\"out\":0,\"body\":\"https://imaguru.by\",\"emoji\":0,\"deleted\":0},{\"id\":52453,\"user_id\":204437607,\"from_id\":204437607,\"date\":1497977813,\"read_state\":1,\"out\":0,\"body\":\"https://youtu.be/hUmkiLeWfJY?t\\u003d1751\",\"emoji\":0,\"deleted\":0},{\"id\":52451,\"user_id\":204437607,\"from_id\":204437607,\"date\":1497432192,\"read_state\":1,\"out\":0,\"body\":\"ANDREI:00253200\\n modem78:11254245\\n modem89:00252989\",\"emoji\":0,\"deleted\":0},{\"id\":52272,\"user_id\":204437607,\"from_id\":204437607,\"date\":1489394963,\"read_state\":1,\"out\":0,\"body\":\"http://macappstore.org/hashcat/\",\"emoji\":0,\"deleted\":0},{\"id\":52261,\"user_id\":204437607,\"from_id\":204437607,\"date\":1489394703,\"read_state\":1,\"out\":0,\"body\":\"\",\"emoji\":0,\"deleted\":0},{\"id\":52258,\"user_id\":204437607,\"from_id\":204437607,\"date\":1489390604,\"read_state\":1,\"out\":0,\"body\":\"\",\"emoji\":0,\"deleted\":0}]}";
        assertEquals(expectedJson, actualJson);
    }

    @Test
    public void getMessageHistory_wrongUserId_EmptyMessageList() throws IOException {
        String targetUrl = "https://api.vk.com/method/messages.getHistory?access_token=9bdcf2fa1612d472284d519d6473f7b8e98498362438b03ecf542f74461fe25c7e15c89ba8d311b5e94b8&v=5.52&offset=0&count=3&user_id=-1";
        String expectedJson = "{\"response\":{\"count\":0,\"items\":[],\"in_read\":0,\"out_read\":0}}";

        httpsGetter = mock(HttpsGetter.class);
        when(httpsGetter.get(targetUrl)).thenReturn(expectedJson);

        vk = new VkMethods(httpsGetter, securityToken, userId);
        String actualJson = new Gson().toJson(vk.getMessageHistory(0, 3, -1));

        expectedJson = "{\"count\":0,\"items\":[]}";
        assertEquals(expectedJson, actualJson);
    }

    @Test
    public void getMessageHistory_allOk_MessageList() throws IOException {
        String targetUrl = "https://api.vk.com/method/messages.getHistory?access_token=9bdcf2fa1612d472284d519d6473f7b8e98498362438b03ecf542f74461fe25c7e15c89ba8d311b5e94b8&v=5.52&offset=0&count=2&user_id=204437607";
        String expectedJson = "{\"response\":{\"count\":46,\"items\":[{\"id\":53007,\"body\":\"he\",\"user_id\":204437607,\"from_id\":204437607,\"date\":1520982614,\"read_state\":1,\"out\":0,\"random_id\":0},{\"id\":53006,\"body\":\"ооллень\",\"user_id\":204437607,\"from_id\":204437607,\"date\":1520982064,\"read_state\":1,\"out\":0,\"random_id\":0}],\"in_read\":53007,\"out_read\":53007}}";

        httpsGetter = mock(HttpsGetter.class);
        when(httpsGetter.get(targetUrl)).thenReturn(expectedJson);
        vk = new VkMethods(httpsGetter, securityToken, userId);

        String actualJson = new Gson().toJson(
                vk.getMessageHistory(0, 2, Integer.parseInt(userId))
        );

        expectedJson = "{\"count\":46,\"items\":[{\"id\":53007,\"user_id\":204437607,\"from_id\":204437607,\"date\":1520982614,\"read_state\":1,\"out\":0,\"body\":\"he\",\"emoji\":0,\"deleted\":0},{\"id\":53006,\"user_id\":204437607,\"from_id\":204437607,\"date\":1520982064,\"read_state\":1,\"out\":0,\"body\":\"ооллень\",\"emoji\":0,\"deleted\":0}]}";
        assertEquals(expectedJson, actualJson);
    }

    @Test
    public void getMessageHistory_offset2_MessagesList() throws IOException {
        String targetUrl = "https://api.vk.com/method/messages.getHistory?access_token=9bdcf2fa1612d472284d519d6473f7b8e98498362438b03ecf542f74461fe25c7e15c89ba8d311b5e94b8&v=5.52&offset=2&count=3&user_id=204437607";
        String expectedJson = "{\"response\":{\"count\":46,\"items\":[{\"id\":53005,\"body\":\"abcdefg\",\"user_id\":204437607,\"from_id\":204437607,\"date\":1520981396,\"read_state\":1,\"out\":0,\"random_id\":0},{\"id\":53004,\"body\":\"abcdefg\",\"user_id\":204437607,\"from_id\":204437607,\"date\":1520932979,\"read_state\":1,\"out\":0,\"random_id\":0},{\"id\":53003,\"body\":\"abcdefg\",\"user_id\":204437607,\"from_id\":204437607,\"date\":1520932478,\"read_state\":1,\"out\":0,\"random_id\":0}],\"in_read\":53007,\"out_read\":53007}}";

        httpsGetter = mock(HttpsGetter.class);
        when(httpsGetter.get(targetUrl)).thenReturn(expectedJson);

        vk = new VkMethods(httpsGetter, securityToken, userId);
        String actualJson = new Gson().toJson(vk.getMessageHistory(2, 3, Integer.parseInt(userId)));

        expectedJson = "{\"count\":46,\"items\":[{\"id\":53005,\"user_id\":204437607,\"from_id\":204437607,\"date\":1520981396,\"read_state\":1,\"out\":0,\"body\":\"abcdefg\",\"emoji\":0,\"deleted\":0},{\"id\":53004,\"user_id\":204437607,\"from_id\":204437607,\"date\":1520932979,\"read_state\":1,\"out\":0,\"body\":\"abcdefg\",\"emoji\":0,\"deleted\":0},{\"id\":53003,\"user_id\":204437607,\"from_id\":204437607,\"date\":1520932478,\"read_state\":1,\"out\":0,\"body\":\"abcdefg\",\"emoji\":0,\"deleted\":0}]}";
        assertEquals(expectedJson, actualJson);

    }

    @Test(expected = SendMessageErrorException.class)
    public void sendMessage_invalidId_SendMessageErrorException() throws SendMessageErrorException, IOException {
        String targetUrl = "https://api.vk.com/method/messages.send?access_token=9bdcf2fa1612d472284d519d6473f7b8e98498362438b03ecf542f74461fe25c7e15c89ba8d311b5e94b8&v=5.52&user_id=-23&message=hello";
        String expextedJson = "{\"error\":{\"error_code\":7,\"error_msg\":\"Permission to perform this action is denied: you are not allowed to send messages to community with id 23\",\"request_params\":[{\"key\":\"oauth\",\"value\":\"1\"},{\"key\":\"method\",\"value\":\"messages.send\"},{\"key\":\"v\",\"value\":\"5.52\"},{\"key\":\"user_id\",\"value\":\"-23\"},{\"key\":\"message\",\"value\":\"hello\"}]}}";

        httpsGetter = mock(HttpsGetter.class);
        when(httpsGetter.get(targetUrl)).thenReturn(expextedJson);
        vk = new VkMethods(httpsGetter, securityToken, userId);

        vk.sendMessage(-23, "hello");
    }

    @Test(expected = NullPointerException.class)
    public void sendMessage_nullMessage_NullPointerException() throws SendMessageErrorException, IOException {
        vk.sendMessage(Integer.parseInt(userId), null);
    }

    @Test
    public void sendMessage_allOK_NoExceptions() throws SendMessageErrorException, IOException {
        String targetUrl = "https://api.vk.com/method/messages.send?access_token=9bdcf2fa1612d472284d519d6473f7b8e98498362438b03ecf542f74461fe25c7e15c89ba8d311b5e94b8&v=5.52&user_id=204437607&message=hello";
        String expextedJson = "{\"response\":53011}";

        httpsGetter = mock(HttpsGetter.class);
        when(httpsGetter.get(targetUrl)).thenReturn(expextedJson);
        vk = new VkMethods(httpsGetter, securityToken, userId);

        vk.sendMessage(Integer.parseInt(userId), "hello");
    }
}